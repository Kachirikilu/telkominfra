<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Kontrol Lampu MQTT (Autentikasi)</title>
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background-color: #2c3e50;
                }
                .container {
                    text-align: center;
                    background: #fff;
                    padding: 40px 60px;
                    border-radius: 15px;
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                }
                .sliders {
                    margin-bottom: 20px;
                }
                h1 {
                    color: #2c3e50;
                    margin-bottom: 25px;
                    font-size: 2.2em;
                }
                .status {
                    font-size: 1.4em;
                    margin-bottom: 20px;
                    font-weight: 600;
                    color: #555;
                }
                #lampu-status {
                    transition: color 0.5s ease;
                }
                .on {
                    color: #2ecc71;
                }
                .off {
                    color: #e74c3c;
                }
                .unknown {
                    color: #95a5a6;
                }
                .control-buttons {
                    display: flex;
                    gap: 20px;
                    justify-content: center;
                }
                #sliderRed, #sliderGreen, #sliderBlue {
                    width: 100%;
                    margin: 10px 0;
                }
                #sliderRed[type="range"] {
                    accent-color: #e74c3c;
                }
                #sliderGreen[type="range"] {
                    accent-color: #2ecc71;
                }
                #sliderBlue[type="range"] {
                    accent-color: #3498db;
                }

                button {
                    padding: 15px 30px;
                    font-size: 1.1em;
                    cursor: pointer;
                    border: none;
                    border-radius: 10px;
                    color: white;
                    transition: transform 0.2s, background-color 0.3s;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                }
                button:active {
                    transform: translateY(2px);
                }
                #on-button {
                    background-color: #2ecc71;
                }
                #on-button:hover {
                    background-color: #27ae60;
                }
                #off-button {
                    background-color: #e74c3c;
                }
                #off-button:hover {
                    background-color: #c0392b;
                }
                .koneksi {
                    font-size: 0.9em;
                    color: #7f8c8d;
                    margin-top: 30px;
                }
                #koneksi-status {
                    font-weight: bold;
                }
            </style>
            <script src="https://cdn.jsdelivr.net/npm/mqtt@4.3.7/dist/mqtt.min.js"></script>
        </head>
        <body>

        <div class="container">
            <h1>Kontrol Lampu Pintar</h1>
            <div class="status">
                Status Lampu: <span id="lampu-status" class="unknown">Tidak Diketahui</span>
            </div>

            <div class="sliders">
                <input id="sliderRed" onchange="slider()" type="range" min="0" max="1023">
                <input id="sliderGreen" onchange="slider()" type="range" min="0" max="1023">
                <input id="sliderBlue" onchange="slider()" type="range" min="0" max="1023">
            </div>
          
            <div class="control-buttons">
                <button onclick="slider('on')" id="on-button">HIDUPKAN</button>
                <button onclick="slider('off')" id="off-button">MATIKAN</button>
            </div>
            <div class="koneksi">
                Status Koneksi: <span id="koneksi-status">Menghubungkan...</span>
            </div>
        </div>

        <script>
            const host = 'broker.mqttdashboard.com';
            const port = 8000;

            // Topik MQTT
            const topicPubs = 'wildan12_lampu/kontrol'; // Topik untuk mengirim perintah
            const topicSubs = 'wildan12_lampu/status'; // Topik untuk menerima status

            // Inisialisasi klien MQTT
            const client = mqtt.connect(`ws://${host}:${port}/mqtt`, {
                reconnectPeriod: 1000
            });

            const statusIndicator = document.getElementById('koneksi-status');
            const lampuStatusEl = document.getElementById('lampu-status');
            
            const sliderRed = document.getElementById('sliderRed');
            const sliderGreen = document.getElementById('sliderGreen');
            const sliderBlue = document.getElementById('sliderBlue');
            const container = document.querySelector('.container');

            const onButton = document.getElementById('on-button');
            const offButton = document.getElementById('off-button');

            // Event saat koneksi berhasil
            client.on('connect', () => {
                console.log('Koneksi berhasil!');
                statusIndicator.textContent = 'Terkoneksi ✔️';
                statusIndicator.style.color = '#2ecc71';
                client.subscribe(topicSubs, (err) => {
                    if (err) {
                        console.error("Gagal subscribe:", err);
                    } else {
                        console.log(`Berhasil subscribe ke topik: ${topicSubs}`);
                    }
                });
            });

            // Event saat koneksi terputus
            client.on('offline', () => {
                console.log('Koneksi terputus!');
                statusIndicator.textContent = 'Koneksi Terputus... ⚠️';
                statusIndicator.style.color = '#e67e22';
            });

            // Event saat terjadi kesalahan
            client.on('error', (error) => {
                console.error('Terjadi kesalahan:', error);
                statusIndicator.textContent = 'Gagal Terkoneksi ❌';
                statusIndicator.style.color = '#e74c3c';
                client.end();
            });

            // Event saat pesan diterima
            client.on('message', (topic, message) => {
                const payload = message.toString();
                console.log(`Pesan diterima dari topik ${topic}: ${payload}`);
                if (topic === topicSubs) {
                    if (payload.toLowerCase() === 'on') {
                        lampuStatusEl.textContent = 'HIDUP';
                        lampuStatusEl.className = 'on';
                    } else if (payload.toLowerCase() === 'off') {
                        lampuStatusEl.textContent = 'MATI';
                        lampuStatusEl.className = 'off';
                    }
                }
            });

            // Fungsi untuk mengirim pesan
            function publishMessage(message) {
                if (client.connected) {
                    client.publish(topicPubs, message, (err) => {
                        if (err) {
                            console.error("Gagal publish:", err);
                        } else {
                            console.log(`Pesan dikirim: ${message} ke topik ${topicPubs}`);
                        }
                    });
                } else {
                    console.warn('Klien tidak terhubung. Tidak dapat mengirim pesan.');
                    alert('Koneksi ke broker belum berhasil. Mohon coba lagi.');
                }
            }

            function slider(x) {
                let colorMessage, red, green, blue;
                if (x == 'on') {
                    publishMessage(JSON.stringify({red: "1023", green: "1023", blue: "1023"}));
                    sliderRed.value = 1023;
                    sliderGreen.value = 1023;
                    sliderBlue.value = 1023;
                    container.style.boxShadow = "0 8px 1000px rgba(255, 255, 255, 1)";
                } else if (x == 'off') {
                    publishMessage(JSON.stringify({red: "0", green: "0", blue: "0"}));
                    sliderRed.value = 0;
                    sliderGreen.value = 0;
                    sliderBlue.value = 0;
                    container.style.boxShadow = "0 8px 25px rgba(0, 0, 0, 0.15)";
                } else {
                    red = sliderRed.value;
                    green = sliderGreen.value;
                    blue = sliderBlue.value;
                    colorMessage = JSON.stringify({
                        red: red,
                        green: green,
                        blue: blue
                    });
                    container.style.boxShadow = `0 8px ${(1000-25)*(red/3069 + green/3069 + blue/3069) + 25}px rgba(${red/4}, ${green/4}, ${blue/4}, ${red/3069 + green/3069 + blue/3069})`;
                    publishMessage(colorMessage);
                }
            }

        </script>

    </body>
</html>